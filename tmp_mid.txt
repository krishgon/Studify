        if (ms <= 0) {
            clearInterval(interval);
            try { chrome.storage.local.remove(STUDY_UNTIL_KEY); } catch (e) {}
            chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
                const isYouTube = tabs[0].url && tabs[0].url.includes('youtube.com');
                updateStatus(isYouTube);
            });
            return;
        }
        render(ms);
    }, 1000);
}

function formatRemaining(ms) {
    let total = Math.ceil(ms / 1000);
    const h = Math.floor(total / 3600);
    total = total % 3600;
    const m = Math.floor(total / 60);
    const s = total % 60;
    if (h > 0) return `${h}h ${m}m ${s}s`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
}

function showBlacklistSection() {
    const section = document.getElementById('blacklist-section');
    section.style.display = 'block';
    document.getElementById('add-blacklist').addEventListener('click', addCurrentSiteToBlacklist);
    loadBlockedSites();
}

function hideBlacklistSection() {
    const section = document.getElementById('blacklist-section');
    section.style.display = 'none';
}

function addCurrentSiteToBlacklist() {
    chrome.tabs.query({ active: true, currentWindow: true }, function(tabs) {
        const url = tabs[0].url || '';
        let hostname = '';
        try {
            hostname = new URL(url).hostname;
        } catch (e) {
            return;
        }
        
        // Prevent YouTube from being added to blacklist
        if (hostname === 'youtube.com' || hostname === 'www.youtube.com' || hostname.endsWith('.youtube.com')) {
            // Show error message or just return without doing anything
            return;
        }
        
        chrome.storage.local.get({ [USER_BLOCK_KEY]: [] }, (data) => {
            const list = data[USER_BLOCK_KEY];
            if (!list.includes(hostname)) {
                list.push(hostname);
                chrome.storage.local.set({ [USER_BLOCK_KEY]: list }, () => {
                    // Reload the current tab after adding to blacklist
                    chrome.tabs.reload(tabs[0].id);
                    // Close the popup
                    window.close();
                });
            } else {
                // If already in blacklist, just reload the page
                chrome.tabs.reload(tabs[0].id);
                window.close();
            }
        });
    });
}

function loadBlockedSites() {
    chrome.storage.local.get({ [USER_BLOCK_KEY]: [] }, (data) => {
        const list = data[USER_BLOCK_KEY];
        const ul = document.getElementById('blocked-list');
        ul.innerHTML = '';
        if (list.length === 0) {
            const li = document.createElement('li');
            li.className = 'empty';
            li.textContent = 'No websites added';
            ul.appendChild(li);
            return;
        }
        list.forEach(site => {
            const li = document.createElement('li');
            const del = document.createElement('button');
            del.className = 'delete-btn';
            
            // Create garbage icon
            const deleteIcon = document.createElement('img');
            deleteIcon.src = chrome.runtime.getURL('icons/delete.png');
            deleteIcon.className = 'delete-icon';
            deleteIcon.alt = 'Delete';
            del.appendChild(deleteIcon);
            
            del.addEventListener('click', () => removeBlockedSite(site));
            const span = document.createElement('span');
            span.textContent = site;
            li.appendChild(del);
            li.appendChild(span);
            ul.appendChild(li);
        });
    });
}

function removeBlockedSite(site) {
    chrome.storage.local.get({ [USER_BLOCK_KEY]: [] }, (data) => {
        const list = data[USER_BLOCK_KEY].filter(s => s !== site);
        chrome.storage.local.set({ [USER_BLOCK_KEY]: list }, loadBlockedSites);
    });
}
